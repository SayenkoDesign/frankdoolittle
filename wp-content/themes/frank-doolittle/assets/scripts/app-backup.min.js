!function($){"use strict";function addToFavoriteModal(item){var favorites=item.post_ids,design=favorites.design,product=favorites.product;design&&addItemToFavoriteModal(design,"design"),product&&addItemToFavoriteModal(product,"product")}function addItemToFavoriteModal(data,type){var html=wp.template("modal-item-favorite")(data);$("#modal-favorites").find("."+type+"-grid").append(html)}function removeFavorite(e){e.preventDefault();var post_id=$(this).parents(".column").data("post-id"),$favorites_modal=$("#modal-favorites");callResource({method:"POST",endpoint:"favorite/delete"},{post_ids:[post_id]},function(response){removeFromModal($favorites_modal,response),$(".add-to-favorites").removeClass("disabled")})}function addToModal($modal,item){var html=wp.template("modal-item")(item);$modal.find(".grid").append(html)}function removeFromModal(modal,response){log(response),_.each(response.post_ids,function(id){log('.column[data-post-id="'+id+'"]'),modal.find('.column[data-post-id="'+id+'"]').remove()}),updateCounts(response)}function removeFromFavoritesModal(response){var $favorites_modal=$("#modal-favorites"),post_ids=_.pluck(response.post_ids,"post_id");_.each(post_ids,function(id){$favorites_modal.find('.column[data-post-id="'+id+'"]').remove()}),updateCounts(response)}function addQuotesToModal(response){_.each(response.post_ids,function(item){addToModal($("#modal-"+item.type),item)}),updateCounts(response)}function _itemExists(post_ids){post_ids=_.isArray(post_ids)?post_ids:[post_ids];var ids=[],$packages=$("#packages");$('.package input[name="post_ids[]"]',$packages).each(function(){ids.push($(this).val())});var found=_.intersection(ids,post_ids);return _.size(found)}function _allowedToRemove(post_ids){post_ids=_.isArray(post_ids)?post_ids:[post_ids];var ids=[],$packages=$("#packages");return $('.package input[name="post_ids[]"]',$packages).each(function(){ids.push($(this).val())}),_.difference(post_ids,ids)}function updateFavoritesCount(newValue){newValue=newValue>0?newValue:"",$(".favorites-and-quotes .favorites .number").text(newValue)}function updateQuoteCount(newValue){newValue=newValue>0?newValue:"",$(".favorites-and-quotes > a.quotes > div > span").text(newValue)}function updateCounts(response){updateQuoteCount(response.quotes_count),updateFavoritesCount(response.favorites_count)}function resetPackages(){log("resetPackages");var $packages=$("#packages");if(!$packages.length)return!1;$(".package",$packages).each(function(){1===$(this).find(".product-attributes .attributes ul").size()&&$(this).find(".product-attributes .attributes ul").find(".remove-attr").hide()}),resetPackageNumbers(),$packages.children().size()||callResource({method:"GET",endpoint:"package/add"},{post_ids:[]},function(response){var package_id=response.package_id;if(package_id){var $packages=$("#packages"),data={package_id:package_id,package_number:$packages.children().size()+1},html=wp.template("single-package")(data);$packages.append(html),resetPackageNumbers()}})}function resetPackageNumbers(){$("#packages").children(".package").each(function(index){$(this).find(".package-number").html(index+1)})}function addToPackage(e){e.preventDefault();var $this=$(this),target_model=$("#"+$this.data("open")),package_id=$this.parents(".package").data("package-id");target_model.attr("data-package-id",package_id)}function loadProductAttributes(element,post_id){post_id&&(finished=!1,$.ajax({method:"GET",url:base_url+"product/"+post_id,beforeSend:function(xhr){xhr.setRequestHeader("X-WP-Nonce",doolittle_rest_object.api_nonce)}}).done(function(response){response.package_attributes&&element.append(response.package_attributes)}).fail(function(){}).always(function(){finished=!0}))}function removeProductAttributes(element){element.find(".package-attributes").remove()}function updatePackage(element){callResource({method:"POST",endpoint:"package/update"},{data:element.find("form").serializeJSON()})}function addRow(element){$("ul:last-child",element).clone(!0,!0).find(":input").val("").end().find(".select-size option:not(:first)").remove().end().appendTo(element)}function removeRow(button){button.closest(".attributes ul").remove()}function trigger_error(msg,display){show_msg('<div class="error">'+msg+"</div>",display)}function show_msg(message,display){var $where=$(".msg");void 0!==display&&($where=$(".msg",display)),$where.append(message),setTimeout(function(){$(".msg").children("div").remove()},3e3)}function log(msg){config.logging&&console.log(msg)}function callResource(config,data,doneCallback,failCallback){return finished=!1,$.ajax({method:config.method,url:base_url+config.endpoint,data:data,beforeSend:function(xhr){xhr.setRequestHeader("X-WP-Nonce",doolittle_rest_object.api_nonce)}}).done(function(response){"function"==typeof doneCallback&&doneCallback(response)}).fail(function(){"function"==typeof failCallback&&failCallback()}).always(function(){finished=!0})}var base_url=doolittle_rest_object.api_url+doolittle_rest_object.api_prefix,config={logging:!0},finished=!0,preventNavigation=function(){if(!finished)return!1};$(window).bind("beforeunload",preventNavigation),$(window).bind("unload",preventNavigation),$(".reveal").on("change",'.column .select-btn input[type="checkbox"]',function(){$(this).parent(".select-btn").toggleClass("checked"),$(this).closest(".column").toggleClass("checked"),$(".add-favorites-to-quote").toggleClass("disabled",$(this).filter(":checked").size()<1)}),$(document).on("closed.zf.reveal","[data-reveal]",function(){$(this).find(".msg .error").remove()}),$("#packages").on("change",".package .attributes .select-color",function(){var $this=$(this),sizes=$(this).find(":selected").data("sizes"),$select=$this.parents(".attributes ul").find(".select-size");$select.find("option").remove(),sizes||(sizes={"":"Size"}),$.each(sizes,function(key,value){$select.append("<option value="+key+">"+value+"</option>")})}),$(document).on("click",".disabled",function(e){return e.preventDefault(),!1}),$(document).on("open.fndtn.reveal","[data-reveal]",function(){$(this).removeAttribute("data-package-id")}),jQuery.fn.outerHTML=function(s){return s?this.before(s).remove():jQuery("<div>").append(this.eq(0).clone()).html()},$("#packages").on("change keyup",".package form :input",function(){var $package=$(this).parents(".package");setTimeout(function(){updatePackage($package)},500)}),$(".add-to-favorites").on("click",function(e){e.preventDefault(),callResource({method:"POST",endpoint:"favorite/add"},{post_ids:[$(this).data("post-id")]},function(response){updateCounts(response),addToFavoriteModal(response),$(".add-to-favorites").addClass("disabled")})}),$("#modal-favorites").on("click",".close-btn",removeFavorite),$("#modal-favorites").on("click",".add-favorites-to-quote",function(e){e.preventDefault();var post_ids=[],$favorites_modal=$("#modal-favorites");$('.column input[type="hidden"]',$favorites_modal).each(function(){post_ids.push($(this).val())}),post_ids.length&&callResource({method:"POST",endpoint:"quote/add"},{post_ids:post_ids},function(response){removeFromFavoritesModal(response),addQuotesToModal(response),$(".add-to-quote").addClass("disabled")})}),$(".add-to-quote").on("click",function(e){e.preventDefault(),callResource({method:"POST",endpoint:"quote/add"},{post_ids:[$(this).data("post-id")]},function(response){updateCounts(response),$(".add-to-quote").addClass("disabled")})}),$("#quotes-modal").on("click",".close-btn",removeFavorite),$("#modal-design").on("click",".close-btn",function(e){e.preventDefault();var post_id=$(this).prev('input[type="hidden"]').val(),$modal=$("#modal-design");_itemExists(post_id)?trigger_error("Design cannot be removed, it has been added to a package.",$modal):callResource({method:"POST",endpoint:"quote/delete"},{post_ids:[post_id]},function(response){removeFromModal($modal,response)})}),$("#modal-design .clear-all").on("click",function(e){e.preventDefault();var post_ids=[],$modal=$("#modal-design");if($('.column input[type="hidden"]',$modal).each(function(){post_ids.push($(this).val())}),post_ids.length){var remove_ids=_allowedToRemove(post_ids);remove_ids.length?callResource({method:"POST",endpoint:"quote/delete"},{post_ids:remove_ids},function(response){removeFromModal($modal,response)}):trigger_error("Designs added to packages cannot be deleted.",$modal)}}),$("#modal-product").on("click",".close-btn",function(e){e.preventDefault();var $modal=$("#modal-product"),post_id=$(this).prev('input[type="hidden"]').val();_itemExists(post_id)?trigger_error("Product cannot be removed, it has been added to a package.",$modal):callResource({method:"POST",endpoint:"quote/delete"},{post_ids:[post_id]},function(response){removeFromModal($modal,response)})}),$("#modal-product .clear-all").on("click",function(e){e.preventDefault();var post_ids=[],$modal=$("#modal-product");if($('.column input[type="hidden"]',$modal).each(function(){post_ids.push($(this).val())}),post_ids.length){var remove_ids=_allowedToRemove(post_ids);remove_ids.length?callResource({method:"POST",endpoint:"quote/delete"},{post_ids:remove_ids},function(response){updateCounts(response),removeFromModal($modal,response)}):trigger_error("Products added to packages cannot be deleted.",$modal)}}),$(window).load(function(){resetPackages()}),$(".add-package ").on("click",function(){callResource({method:"GET",endpoint:"package/add"},{post_ids:[]},function(response){var package_id=response.package_id;if(package_id){var $packages=$("#packages"),data={package_id:package_id,package_number:$packages.children().size()+1},html=wp.template("single-package")(data);$packages.append(html),$(".package .product-attributes .attributes ul:first-child","#packages").find(".remove-attr").hide()}})}),$("#packages").on("click",".package .remove-package",function(e){e.preventDefault(),callResource({method:"POST",endpoint:"package/delete"},{post_ids:[$(this).parents(".package").data("package-id")]},function(response){_.isArray(response.packages)?(_.each(response.packages,function(id){$("#packages").find('.package[data-package-id="'+id+'"]').remove()}),updateCounts(response),resetPackages()):setErrorMessage("Could not delete package")})}),$(".remove-packages").on("click",function(e){e.preventDefault();var post_ids=[],$packages=$("#packages");$(".package",$packages).each(function(){post_ids.push($(this).data("package-id"))}),post_ids.length&&callResource({method:"POST",endpoint:"package/delete"},{post_ids:post_ids},function(response){_.each(response.packages,function(id){$packages.find('.package[data-package-id="'+id+'"]').remove()}),updateCounts(response),resetPackages()})}),$("#packages").on("click",".package .select-design .add-to-package",addToPackage),$("#packages").on("click",".package .selected-design .close-btn",function(){var $this=$(this),$column=$this.parents(".column"),$package=$this.parents(".package"),$place_holder=$column.parents(".select-design").find(".place-holder"),$selected=$column.parents(".selected-design");$column.remove(),$place_holder.removeClass("hide"),$selected.addClass("hide"),updatePackage($package)}),$("#packages").on("click",".package .select-product .add-to-package",addToPackage),$("#packages").on("click",".package .selected-product .close-btn",function(){var $this=$(this),$column=$this.parents(".column"),$package=$this.parents(".package"),$place_holder=$column.parents(".select-product").find(".place-holder"),$selected=$column.parents(".selected-product");$column.remove(),$place_holder.removeClass("hide"),$selected.addClass("hide"),removeProductAttributes($package),updatePackage($package)}),$("#modal-design").on("click",".grid .column .image",function(){var $column=$(this).parents(".column"),$modal=$("#modal-design"),package_id=$modal.attr("data-package-id"),$package=$("#packages").find('.package[data-package-id="'+package_id+'"]'),$place_holder=$package.find(".select-design .place-holder"),$selected=$package.find(".selected-design");$place_holder.addClass("hide"),$selected.append($column.outerHTML()),$selected.removeClass("hide"),$modal.foundation("close"),updatePackage($package)}),$("#modal-product").on("click",".grid .column .image",function(){var $column=$(this).parents(".column"),post_id=$column.data("post-id"),$modal=$("#modal-product"),package_id=$modal.attr("data-package-id"),$package=$("#packages").find('.package[data-package-id="'+package_id+'"]'),$place_holder=$package.find(".select-product .place-holder"),$selected=$package.find(".selected-product");$place_holder.addClass("hide"),$selected.append($column.outerHTML()),$selected.removeClass("hide"),$modal.foundation("close"),loadProductAttributes($(".package-details",$package),post_id),updatePackage($package)}),$('.confirm-sizes input[name="sizes"]:checked').on("change",function(){"yes"===$('input[name="sizes"]:checked').val()&&$(" .product-attributes").removeClass("hidden")}),$("#packages").on("click",".package .product-attributes .add-attr",function(e){e.preventDefault();var $parent=$(this).parents(".package").find(".attributes");addRow($parent),$("ul",$parent).size()>1&&$(".remove-attr").show(),updatePackage($(this,"#packages").parents(".package"))}),$("#packages").on("click",".package .product-attributes .remove-attr",function(e){e.preventDefault();var $package=$(this).parents(".package"),$row=$package.find(".attributes");1==$("ul",$row).size()?$(".remove-attr",$row).hide():removeRow($(this)),1==$("ul",$row).size()&&$(".remove-attr",$row).hide(),updatePackage($package)}),$("#packages").on("change",'input[name="sizes"]',function(){$(this).parents(".package-details").find(".product-attributes").toggleClass("hide")}).change()}(jQuery);